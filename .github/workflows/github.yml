---
name: Github Repository Settings

on:
  workflow_call:
    secrets:
      GH_CLI_TOKEN:
        description: 'PSA Token for gh cli access.'
        required: false

env:
  GITHUB_REPOSITORY: ${{ github.repository }}

jobs:
  github:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up yq
        uses: frenck/action-setup-yq@v1

      - name: gh repo edit
        run: |
          # add-topic must be splittet into one command for each topic
          yq '.repo | with_entries(select(.key != "add-topic"))' .github/settings.yaml | tr -d : >  gh_repo
          yq '.repo | with_entries(select(.key == "add-topic")) | to_entries | .[].value[] | sub("(.*)", "add-topic ${0}")' .github/settings.yaml >>  gh_repo
          # get and set settings
          cat gh_repo | sed 's/\"/\\"/g' | while read repo_cmd; do gh repo edit ${GITHUB_REPOSITORY} --$repo_cmd; done
        env:
          GH_TOKEN: ${{ secrets.GH_CLI_TOKEN }}
